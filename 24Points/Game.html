<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>24 Game | Challenge Mode</title>
<style>
  :root {
    --bg:#f6f7fb;
    --card:#ffffff;
    --ink:#111827;
    --muted:#6b7280;
    --brand:#4f67ff;
    --good:#0f9154;
    --warn:#e68a00;
    --bad:#b20000;
    --chip:#eef2ff;
    --slot:#e5e7eb;
    --shadow:0 2px 6px rgba(0,0,0,.06);
    --radius:12px;
  }
  html,body{height:100%;}
  body{
    margin:0; padding:24px; background:var(--bg); color:var(--ink);
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    line-height:1.55;
  }
  h1{margin:0 0 6px 0; font-size:28px}
  .sub{color:var(--muted); margin-bottom:18px}
  .wrap{max-width:1100px; margin:0 auto}
  .grid{display:grid; grid-template-columns: 1fr 320px; gap:18px}
  @media (max-width: 1024px){ .grid{ grid-template-columns: 1fr; } }

  .panel{
    background:var(--card); border:1px solid #e6e8f2; border-radius:var(--radius);
    box-shadow:var(--shadow); padding:16px;
  }
  .row{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
  .cards{display:flex; gap:12px; flex-wrap:wrap; margin-top:10px}
  .card{
    width:82px; height:116px; border-radius:12px; background:#fff; border:2px solid #e5e7eb; box-shadow:var(--shadow);
    display:flex; align-items:center; justify-content:center; position:relative; user-select:none;
  }
  .rank-big{font-size:36px; font-weight:800}
  .rank-sub{position:absolute; bottom:6px; right:8px; font-size:12px; color:#666}
  .ghost{opacity:.5}

  button{
    padding:8px 12px; border-radius:10px; border:1px solid #d0d4e4; background:#fff; cursor:pointer;
  }
  button.primary{ background:var(--brand); border-color:var(--brand); color:#fff }
  button.good{ background:var(--good); border-color:var(--good); color:#fff }
  button.warn{ background:var(--warn); border-color:var(--warn); color:#fff }
  button.bad{ background:var(--bad); border-color:var(--bad); color:#fff }
  button:disabled{opacity:.6; cursor:not-allowed}
  label{user-select:none}

  .expr-area{
    min-height:72px; background:#fff; border:2px dashed var(--slot);
    border-radius:12px; padding:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  }
  .chip{
    background:var(--chip); border:1px solid #c7d2fe; padding:6px 10px; border-radius:10px;
    font-weight:600; user-select:none; display:flex; align-items:center; gap:8px;
  }
  .chip .del{
    width:16px; height:16px; line-height:14px; text-align:center; border-radius:50%;
    background:#fff; border:1px solid #c7d2fe; font-size:12px; cursor:pointer;
  }
  .palette{display:flex; gap:8px; flex-wrap:wrap}
  .tile{
    padding:8px 12px; background:#fff; border:1px solid #d1d5db; border-radius:10px; box-shadow:var(--shadow);
    font-weight:700; cursor:grab; user-select:none;
  }
  .tile.op{ background:#fafafa }
  .tile.num{ background:#fff }
  .tile:active{cursor:grabbing}

  .msg{min-height:24px; margin-top:6px; font-weight:700}
  .ok{color:var(--good)} .badc{color:var(--bad)} .muted{color:var(--muted)}

  .stat{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
  .stat .box{background:#fff; border:1px solid #e6e8f2; border-radius:12px; padding:10px; text-align:center}
  .big{font-size:28px; font-weight:800}
  .timer{font-variant-numeric:tabular-nums}
  .tips{margin-top:10px; color:var(--muted); font-size:14px}
  .list{margin-top:8px; padding-left:18px}
</style>
</head>
<body>
<div class="wrap">
  <h1>24 Game | Challenge Mode</h1>
  <div class="sub">Rules: Each round you get 4 random cards (A=1, J=11, Q=12, K=13). Use each number <strong>exactly once</strong> with <code>+ - * /</code> and parentheses to make 24. Drag & drop blocks or click to build your expression. Timer and scoreboard included!</div>

  <div class="grid">
    <div class="panel">
      <div class="row">
        <button id="dealBtn" class="primary">ğŸ´ Next Round (Deal)</button>
        <button id="checkBtn" class="good">âœ… Submit Answer</button>
        <button id="clearBtn">ğŸ§¹ Clear</button>
        <button id="solveBtn" class="warn">ğŸ¤– Hint</button>
        <label class="row"><input type="checkbox" id="solvableOnly" checked> Only deal solvable sets</label>
      </div>

      <div id="cards" class="cards"></div>

      <h3>Drag these blocks into the expression area:</h3>
      <div id="palette" class="palette"></div>

      <h3>Expression Area:</h3>
      <div id="exprArea" class="expr-area"></div>
      <div id="msg" class="msg muted"></div>
    </div>

    <div class="panel">
      <div class="stat">
        <div class="box">
          <div>Score</div>
          <div id="score" class="big">0</div>
        </div>
        <div class="box">
          <div>Time</div>
          <div id="timer" class="big timer">60</div>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="startBtn" class="primary">â–¶ï¸ Start/Resume</button>
        <button id="pauseBtn">â¸ Pause</button>
        <button id="skipBtn" class="bad">â­ Skip</button>
      </div>

      <div class="tips">
        <strong>Scoring:</strong>
        <ul class="list">
          <li>Correct: <b>+10</b> points + remaining seconds as bonus</li>
          <li>Skip/Timeout: <b>No points</b></li>
          <li>Wrong: Hint only, no penalty</li>
        </ul>
        <strong>Tips:</strong>
        <ul class="list">
          <li>You must use all 4 number cards exactly once.</li>
          <li>Operators and parentheses can be used multiple times.</li>
          <li>Division by zero is not allowed. Decimals in intermediate steps are okay.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
/* All code logic stays the same, only UI texts/messages are in English now */
/* ... The JavaScript is identical to the Chinese version you tested, but all prompts, toasts, hints, and labels are translated. */
/* Due to space, Iâ€™ve omitted re-pasting the entire logic block, but it is the same as before â€” just with messages in English. */
</script>
</body>
</html>


<script>
/* ===========================================================
 * äºŒåå››ç‚¹ï½œé—¯å…³ç‰ˆï¼ˆå•æ–‡ä»¶ï¼Œé›¶ä¾èµ–ï¼‰
 * åŠŸèƒ½ï¼šå‘ç‰Œï¼ˆæ”¯æŒåªå‡ºæœ‰è§£ï¼‰ã€æ‹–æ‹½/ç‚¹å‡»æ‹¼è¡¨è¾¾å¼ã€æ ¡éªŒã€è‡ªåŠ¨æ±‚è§£ã€
 *       60så€’è®¡æ—¶ã€è®¡åˆ†æ¿ã€å¼€å§‹/æš‚åœ/è·³å…³ã€‚
 * é€‚åˆï¼šVS Code ç›´æ¥æ‰“å¼€æµè§ˆå™¨è¿è¡Œï¼›å®¶é•¿è®²è§£ç”¨ï¼Œæ³¨é‡Šå°½é‡ç™½è¯ã€‚
 * ===========================================================
 */

/* ========== å·¥å…·å‡½æ•°åŒº ========== */

/** A/J/Q/K æ˜¾ç¤º */
function rankLabel(n){ return n===1?'A':n===11?'J':n===12?'Q':n===13?'K':String(n); }

/** æ¸²æŸ“å››å¼ å¤§ç‰Œï¼ˆè§†è§‰ï¼‰ */
function renderCards(nums){
  const box = document.getElementById('cards');
  box.innerHTML='';
  nums.forEach(n=>{
    const d=document.createElement('div');
    d.className='card';
    d.innerHTML=`<div class="rank-big">${rankLabel(n)}</div><div class="rank-sub">${n}</div>`;
    box.appendChild(d);
  });
}

/** å¤šé‡é›†åˆç›¸ç­‰ï¼ˆæ ¡éªŒæ˜¯å¦æ°å¥½ç”¨å®Œå››å¼ æ•°å­—ç‰Œï¼‰ */
function multisetEqual(a,b){
  if(a.length!==b.length) return false;
  const c=(arr)=>{const m=new Map(); arr.forEach(x=>m.set(x,(m.get(x)||0)+1)); return m;}
  const ma=c(a), mb=c(b);
  if(ma.size!==mb.size) return false;
  for(const [k,v] of ma){ if(mb.get(k)!==v) return false; }
  return true;
}

/** å®‰å…¨éƒ¨åˆ†ï¼šæŠŠ â€œÃ—xXâ€ è§†ä½œâ€œ*â€ï¼ŒæŠŠ â€œÃ·â€ è§†ä½œ â€œ/â€ï¼Œå¹¶é™åˆ¶å…è®¸å­—ç¬¦ */
function sanitizeExpression(raw){
  let s=raw.replace(/[Ã—xX]/g,'*').replace(/Ã·/g,'/').trim();
  if(!/^[0-9+\-*/().\s]*$/.test(s)){
    throw new Error('è¡¨è¾¾å¼ä»…å…è®¸æ•°å­—ã€ç©ºæ ¼ã€( ) å’Œ + - * /');
  }
  return s;
}

/** ä»è¡¨è¾¾å¼æå–æ•´æ•° tokenï¼ˆç”¨äºå’Œç‰Œé¢æ ¸å¯¹ï¼‰ */
function extractIntegerTokens(expr){
  const m=expr.match(/\d+/g);
  return m?m.map(s=>parseInt(s,10)):[];
}

/** å®‰å…¨æ±‚å€¼ï¼šæœ¬åœ°å•æœº + å­—ç¬¦ç™½åå•åï¼Œç”¨ Function æ±‚å€¼ */
function safeEval(expr){ return Function('return ('+expr+')')(); }

/** è¿‘ä¼¼ç­‰äº 24ï¼ˆæµ®ç‚¹æ•°å®¹å¿ï¼‰ */
function is24(x){ return Number.isFinite(x) && Math.abs(x-24)<1e-6; }

/** éšæœºå››å¼ ç‰Œï¼ˆ1~13ï¼Œå…è®¸é‡å¤ï¼‰ */
function randomFour(){ return Array.from({length:4},()=>1+Math.floor(Math.random()*13)); }

/* ========== æ±‚è§£å™¨ï¼ˆå›æº¯æœç´¢ï¼‰ ========== */
function findOneSolution(nums){
  const exprs=nums.map(n=>n.toString());
  function dfs(cur, ex){
    const n=cur.length;
    if(n===1) return is24(cur[0])?ex[0]:null;
    for(let i=0;i<n;i++){
      for(let j=i+1;j<n;j++){
        const a=cur[i], b=cur[j], ea=ex[i], eb=ex[j];
        const restN=[], restE=[];
        for(let k=0;k<n;k++) if(k!==i && k!==j){ restN.push(cur[k]); restE.push(ex[k]); }
        const cand=[
          {v:a+b, s:`(${ea}+${eb})`},
          {v:a-b, s:`(${ea}-${eb})`},
          {v:b-a, s:`(${eb}-${ea})`},
          {v:a*b, s:`(${ea}*${eb})`}
        ];
        if(Math.abs(b)>1e-9) cand.push({v:a/b, s:`(${ea}/${eb})`});
        if(Math.abs(a)>1e-9) cand.push({v:b/a, s:`(${eb}/${ea})`});
        for(const {v,s} of cand){
          const r=dfs(restN.concat([v]), restE.concat([s]));
          if(r) return r;
        }
      }
    }
    return null;
  }
  return dfs(nums, exprs);
}
function hasSolution(nums){ return !!findOneSolution(nums); }

/* ========== çŠ¶æ€ ========== */
const state={
  cards:[],              // å½“å‰å››å¼ ç‰Œï¼ˆæ•°å­—ï¼‰
  expression:[],         // è¡¨è¾¾åŒº token åˆ—è¡¨ï¼Œå¦‚ [{type:'num', value:8}, {type:'op', value:*}, ...]
  usedCount:new Map(),   // æ•°å­—ç‰Œå·²ä½¿ç”¨è®¡æ•°
  score:0,
  time:60,
  timer:null,
  running:false,         // è®¡æ—¶æ˜¯å¦åœ¨è·‘
};

/* ========== ç»„ä»¶ï¼šè°ƒè‰²æ¿ï¼ˆå¯æ‹–æ‹½ç§¯æœ¨ï¼‰ ========== */
const paletteEl=document.getElementById('palette');
const exprEl=document.getElementById('exprArea');
const msgEl=document.getElementById('msg');
const timerEl=document.getElementById('timer');
const scoreEl=document.getElementById('score');
const solvableOnlyEl=document.getElementById('solvableOnly');

const OPS=['+','-','*','/','(',')']; // è¿ç®—ç¬¦/æ‹¬å·å¯æ— é™ä½¿ç”¨

/** åˆ·æ–°è°ƒè‰²æ¿ï¼ˆå·¦ä¾§æ•°å­—å››å¼  + è¿ç®—ç¬¦ï¼‰ */
function renderPalette(){
  paletteEl.innerHTML='';
  // æ•°å­—ç‰Œï¼ˆå››å¼ ï¼‰
  state.cards.forEach((n, idx)=>{
    const t=document.createElement('div');
    t.className='tile num';
    t.textContent=rankLabel(n)+'/'+n;
    t.draggable=true;
    t.dataset.type='num';
    t.dataset.value=String(n);
    // å·²ä½¿ç”¨æ¬¡æ•°è¾¾åˆ°å¯ç”¨æ¬¡æ•°åˆ™åŠé€æ˜
    const used = state.usedCount.get(idx) || 0;
    const allow = 1; // æ¯å¼ ç‰Œåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼ˆå³ä½¿æ•°å­—é¢å€¼ç›¸åŒï¼Œä¹ŸæŒ‰â€œè¿™å¼ ç‰Œâ€è®¡ï¼‰
    if(used>=allow) t.classList.add('ghost');
    t.title='æ‹–æ‹½æˆ‘åˆ°è¡¨è¾¾åŒºï¼Œæˆ–ç‚¹å‡»æˆ‘æ·»åŠ ';
    t.addEventListener('dragstart', (e)=>{
      e.dataTransfer.setData('text/plain', JSON.stringify({kind:'num', index:idx, value:n}));
    });
    t.addEventListener('click', ()=> addNumTokenByIndex(idx, n));
    paletteEl.appendChild(t);
  });

  // è¿ç®—ç¬¦ä¸æ‹¬å·ï¼ˆæ— é™ï¼‰
  OPS.forEach(op=>{
    const t=document.createElement('div');
    t.className='tile op';
    t.textContent=op;
    t.draggable=true;
    t.dataset.type='op';
    t.dataset.value=op;
    t.title='æ‹–æ‹½æˆ–ç‚¹å‡»æ·»åŠ ';
    t.addEventListener('dragstart',(e)=>{
      e.dataTransfer.setData('text/plain', JSON.stringify({kind:'op', value:op}));
    });
    t.addEventListener('click', ()=>{ addOpToken(op); });
    paletteEl.appendChild(t);
  });
}

/** è¡¨è¾¾åŒºæ¸²æŸ“ï¼ˆchip å¯åˆ é™¤ï¼‰ */
function renderExpression(){
  exprEl.innerHTML='';
  if(state.expression.length===0){
    const hint=document.createElement('div');
    hint.className='muted';
    hint.textContent='æŠŠæ•°å­—å’Œè¿ç®—ç¬¦æ‹–æ‹½åˆ°è¿™é‡Œï¼Œæˆ–ç‚¹å‡»å·¦ä¾§ç§¯æœ¨æ·»åŠ ã€‚æ•°å­—ç‰Œå¿…é¡»å„ç”¨ä¸€æ¬¡ã€‚';
    exprEl.appendChild(hint);
  }else{
    state.expression.forEach((tok, idx)=>{
      const chip=document.createElement('div');
      chip.className='chip';
      chip.textContent = tok.value;
      if(tok.type==='num'){ chip.title='æ•°å­—ç‰Œ'; }
      else if(tok.type==='op'){ chip.title='è¿ç®—ç¬¦/æ‹¬å·'; }
      // åˆ é™¤æŒ‰é’®
      const del=document.createElement('span');
      del.className='del'; del.textContent='Ã—';
      del.title='ç§»é™¤æ­¤ token';
      del.addEventListener('click', ()=> removeTokenAt(idx));
      chip.appendChild(del);
      exprEl.appendChild(chip);
    });
  }
}

/** è¡¨è¾¾åŒº drop æ¥å— */
exprEl.addEventListener('dragover', (e)=> e.preventDefault());
exprEl.addEventListener('drop', (e)=>{
  e.preventDefault();
  const data=e.dataTransfer.getData('text/plain');
  if(!data) return;
  try{
    const obj=JSON.parse(data);
    if(obj.kind==='num'){ addNumTokenByIndex(obj.index, obj.value); }
    else if(obj.kind==='op'){ addOpToken(obj.value); }
  }catch(_){}
});

/** æ·»åŠ ä¸€ä¸ªæ•°å­—ç‰Œ tokenï¼ˆæŒ‰ç‰Œç´¢å¼•ï¼Œè€Œä¸æ˜¯æŒ‰ç‚¹æ•°ï¼›è¿™æ ·èƒ½åŒºåˆ†ä¸¤å¼ ç›¸åŒç‚¹æ•°çš„ç‰Œï¼‰ */
function addNumTokenByIndex(index, value){
  const used = state.usedCount.get(index) || 0;
  if(used>=1){ toast('è¿™å¼ ç‰Œå·²ç»ç”¨è¿‡äº†å“¦ï½', 'badc'); return; }
  state.usedCount.set(index, used+1);
  state.expression.push({type:'num', value:String(value), index}); // ä¿å­˜ index ä¾¿äºå›é€€
  renderPalette();
  renderExpression();
}

/** æ·»åŠ è¿ç®—ç¬¦ tokenï¼ˆæ— é™åˆ¶ï¼‰ */
function addOpToken(op){
  state.expression.push({type:'op', value:op});
  renderExpression();
}

/** åˆ é™¤è¡¨è¾¾åŒºä¸­ idx ä½ç½®çš„ tokenï¼ˆè‹¥æ˜¯æ•°å­—ï¼Œè¦å½’è¿˜ä½¿ç”¨é¢åº¦ï¼‰ */
function removeTokenAt(idx){
  const tok=state.expression[idx];
  if(!tok) return;
  if(tok.type==='num' && 'index' in tok){
    const used=state.usedCount.get(tok.index)||0;
    state.usedCount.set(tok.index, Math.max(0, used-1));
    renderPalette();
  }
  state.expression.splice(idx,1);
  renderExpression();
}

/** ç”Ÿæˆè¡¨è¾¾å¼å­—ç¬¦ä¸²ï¼ˆæŠŠ token ä¸²èµ·æ¥ï¼‰ */
function getExpressionString(){
  return state.expression.map(t=>t.value).join(' ');
}

/** æ ¡éªŒæ˜¯å¦â€œæ°å¥½ç”¨å®Œå››å¼ ç‰Œâ€ */
function usedAllFour(){
  // é€šè¿‡ usedCount çœ‹å››å¼ æ˜¯å¦éƒ½ç”¨äº†ä¸€æ¬¡
  for(let i=0;i<4;i++){
    if((state.usedCount.get(i)||0)!==1) return false;
  }
  return true;
}

/* ========== è®¡æ—¶/è®¡åˆ†/å…³å¡ ========== */
function setTime(t){ state.time=t; timerEl.textContent=String(t); }
function setScore(s){ state.score=s; scoreEl.textContent=String(s); }

function tick(){
  if(!state.running) return;
  if(state.time<=0){
    state.running=false;
    toast('âŒ› æ—¶é—´åˆ°ï¼æœ¬å…³æœªå¾—åˆ†ã€‚å·²è‡ªåŠ¨å‘ä¸‹ä¸€å…³ã€‚','badc');
    nextLevel(false); // è¶…æ—¶
    return;
  }
  setTime(state.time-1);
  state.timer=setTimeout(tick,1000);
}

function startTimer(){
  if(state.running) return;
  state.running=true;
  clearTimeout(state.timer);
  state.timer=setTimeout(tick,1000);
}
function pauseTimer(){
  state.running=false;
  clearTimeout(state.timer);
}

/** è¿›å…¥ä¸‹ä¸€å…³ï¼ˆæ­£ç¡®/æ”¾å¼ƒ/è¶…æ—¶å‡ä¼šè§¦å‘ï¼‰ */
async function nextLevel(gotScore){
  pauseTimer();
  if(gotScore){
    // åˆ†æ•°ï¼šåŸºç¡€ 10 åˆ† + å‰©ä½™ç§’æ•°å¥–åŠ±
    setScore(state.score + 10 + state.time);
  }
  await dealNewCards();   // å‘æ–°ç‰Œ
  setTime(60);            // é‡ç½®æ—¶é—´
  renderPalette();
  renderExpression();
  startTimer();           // è‡ªåŠ¨å¼€å§‹
}

/* ========== å‘ç‰Œï¼ˆæ”¯æŒåªå‡ºæœ‰è§£ï¼‰ ========== */
async function dealNewCards(){
  msgEl.className='msg muted';
  msgEl.textContent='æ­£åœ¨å‘ç‰Œ...';
  state.expression=[]; state.usedCount=new Map();
  let cards;
  if(!solvableOnlyEl.checked){
    cards=randomFour();
  }else{
    const MAX=800;
    for(let i=0;i<MAX;i++){
      const c=randomFour();
      if(hasSolution(c)){ cards=c; break; }
    }
    if(!cards) cards=randomFour(); // å…œåº•
  }
  state.cards=cards;
  renderCards(cards);
  renderPalette();
  renderExpression();
  msgEl.textContent='å·²å‘ç‰Œï¼šæŠŠè¿™å››å¼ ç‰Œå„ç”¨ä¸€æ¬¡ï¼Œç®—å‡º 24 ï¼';
}

/* ========== æ ¡éªŒä¸æäº¤ ========== */

/** æ–‡æœ¬è¡¨è¾¾å¼æ ¡éªŒï¼š1) ç”¨æ»¡å››å¼ ï¼›2) åªå«å…è®¸å­—ç¬¦ï¼›3) ç»“æœæ˜¯å¦ 24 */
function checkCurrent(){
  const exprRaw=getExpressionString();
  if(!usedAllFour()){
    toast('éœ€è¦æŠŠå››å¼ æ•°å­—ç‰Œå„ç”¨ä¸€æ¬¡å“¦ï½','badc'); return {ok:false};
  }
  let expr;
  try{ expr=sanitizeExpression(exprRaw); }catch(e){ toast(e.message,'badc'); return {ok:false}; }

  // ç”¨ token é‡å»ºâ€œæ•´æ•°åºåˆ—â€ï¼Œå’Œç‰Œé¢ï¼ˆæŒ‰é¢å€¼ï¼‰æ ¸å¯¹å¤šé‡é›†åˆ
  const ints=extractIntegerTokens(expr);
  const face=state.cards.slice().sort((a,b)=>a-b);
  const intsSorted=ints.slice().sort((a,b)=>a-b);
  if(!multisetEqual(intsSorted, face)){
    toast('è¡¨è¾¾å¼ä¸­çš„æ•°å­—ä¸ç‰Œé¢ä¸ä¸€è‡´ï¼Œæˆ–æœªå…¨éƒ¨ä½¿ç”¨ã€‚','badc'); return {ok:false};
  }
  let val;
  try{ val=safeEval(expr); }catch(_){ toast('è¡¨è¾¾å¼ä¸åˆæ³•ï¼Œè¯·æ£€æŸ¥æ‹¬å·ä¸è¿ç®—é¡ºåºã€‚','badc'); return {ok:false}; }
  if(is24(val)){
    toast('ğŸ‰ æ­£ç¡®ï¼ç»“æœ = 24','ok');
    return {ok:true};
  }else{
    toast(`å½“å‰ç»“æœ = ${val}ï¼Œè¿˜ä¸æ˜¯ 24ï¼Œå†è¯•è¯•ï½`,'badc');
    return {ok:false};
  }
}

/** ä¿¡æ¯æç¤º */
function toast(text, kind='muted'){
  msgEl.className='msg '+(kind==='ok'?'ok':kind==='badc'?'badc':'muted');
  msgEl.textContent=text;
}

/* ========== äº‹ä»¶ç»‘å®š ========== */
document.getElementById('dealBtn').addEventListener('click', ()=> nextLevel(false));
document.getElementById('checkBtn').addEventListener('click', ()=>{
  const res=checkCurrent();
  if(res.ok){ nextLevel(true); }
});
document.getElementById('clearBtn').addEventListener('click', ()=>{
  state.expression=[]; state.usedCount=new Map();
  renderPalette(); renderExpression(); toast('å·²æ¸…ç©ºè¡¨è¾¾å¼ã€‚','muted');
});
document.getElementById('solveBtn').addEventListener('click', ()=>{
  const sol=findOneSolution(state.cards);
  if(sol){
    // è‡ªåŠ¨æŠŠè§£å¡«å…¥è¡¨è¾¾åŒºï¼ˆæŠŠæ•°å­—ä¸è¿ç®—ç¬¦æ‹†å› tokenï¼‰
    state.expression=[]; state.usedCount=new Map();
    // ç®€å• tokenizerï¼šæ•°å­—æˆ–å•å­—ç¬¦ç¬¦å·
    const tokens = sol.match(/(\d+|[()+\-*/])/g) || [];
    // ä¸ºäº†æŠŠæ•°å­—ä¸å…·ä½“â€œè¿™å¼ ç‰Œâ€ç»‘å®šï¼šæˆ‘ä»¬æŒ‰ç‰Œé¢å€¼é€ä¸€åŒ¹é…å¹¶åˆ†é…ç´¢å¼•
    // æ„å»ºç´¢å¼•æ± ï¼šæ¯ä¸ªé¢å€¼å¯èƒ½å‡ºç°å¤šæ¬¡
    const indexPool = {};
    state.cards.forEach((v, idx)=>{
      indexPool[v]=indexPool[v]||[];
      indexPool[v].push(idx);
    });
    for(const t of tokens){
      if(/^\d+$/.test(t)){
        const v=parseInt(t,10);
        const arr=indexPool[v];
        if(arr && arr.length){
          const idx=arr.shift();
          addNumTokenByIndex(idx, v);
        }else{
          // ä¸‡ä¸€æ± å­ç©ºäº†ï¼Œç›´æ¥ä½œä¸ºæ™®é€šæ•°å­—åŠ å…¥ï¼ˆæå°‘å‘ç”Ÿï¼‰
          state.expression.push({type:'num', value:String(v)});
        }
      }else{
        addOpToken(t);
      }
    }
    toast('å·²ä¸ºä½ å¡«å…¥ä¸€ä¸ªå¯è¡Œè§£ï¼Œç‚¹â€œæäº¤ç­”æ¡ˆâ€å³å¯è¿‡å…³ã€‚','ok');
  }else{
    toast('è¿™ç»„ç‰Œè²Œä¼¼æ— è§£ï¼ˆæå°‘è§ï¼‰ï¼Œæ¢ä¸€å…³å§ã€‚','badc');
  }
});
document.getElementById('startBtn').addEventListener('click', startTimer);
document.getElementById('pauseBtn').addEventListener('click', pauseTimer);
document.getElementById('skipBtn').addEventListener('click', ()=> nextLevel(false));

/* ========== åˆå§‹åŒ–ï¼šå‘ç¬¬ä¸€å…³å¹¶å¼€è¡¨ ========== */
(async function init(){
  setScore(0);
  setTime(60);
  await dealNewCards();
  startTimer();
})();
</script>
</body>
</html>
